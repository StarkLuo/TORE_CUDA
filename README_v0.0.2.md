# TORE CUDA v0.0.2

TORE (Time-Ordered REpresentation) CUDAå®ç°ï¼Œæ”¯æŒäº‹ä»¶ç›¸æœºçš„æ—¶ç©ºè¡¨ç¤ºæ„å»ºï¼Œæ–°å¢äº‹ä»¶resizeåŠŸèƒ½ä»¥å…¼å®¹å›ºå®špatch sizeçš„æ¨¡å‹ï¼ˆå¦‚ViTï¼‰ã€‚

## ç‰ˆæœ¬ä¿¡æ¯
- å½“å‰ç‰ˆæœ¬: 0.0.2
- æ–°å¢åŠŸèƒ½: äº‹ä»¶resizeæ”¯æŒï¼ˆæŒ‰æ¯”ä¾‹resizeå’Œæ­£æ–¹å½¢resizeï¼‰
- æ–°å¢åŠŸèƒ½: è‡ªåŠ¨ç±»å‹è½¬æ¢æ”¯æŒï¼ˆint32/float32ç­‰è‡ªåŠ¨è½¬æ¢ä¸ºfloat32ï¼‰
- å‘åå…¼å®¹: å®Œå…¨å…¼å®¹v0.0.1ç‰ˆæœ¬çš„æ‰€æœ‰æ¥å£

## å®‰è£…

```bash
pip install .
```

## æ ¸å¿ƒæ¦‚å¿µ

TOREå°†äº‹ä»¶æµè½¬æ¢ä¸ºæ—¶ç©ºä½“ç§¯è¡¨ç¤ºï¼Œæ¯ä¸ªåƒç´ ä½ç½®ä¿ç•™æœ€è¿‘çš„Kä¸ªäº‹ä»¶æ—¶é—´æˆ³ï¼Œç”¨äºåç»­çš„æ·±åº¦å­¦ä¹ å¤„ç†ã€‚

## APIé€‰æ‹©æŒ‡å—

### ğŸ” å¦‚ä½•é€‰æ‹©åˆé€‚çš„APIæ¥å£ï¼Ÿ

æ ¹æ®æ‚¨çš„ä½¿ç”¨åœºæ™¯ï¼Œé€‰æ‹©æœ€é€‚åˆçš„APIæ¥å£ï¼š

| åœºæ™¯ | æ¨èAPI | è¯´æ˜ |
|------|---------|------|
| **å•å¼ å›¾åƒå¤„ç†** | `tore_build_single` | å¤„ç†å•ä¸ªäº‹ä»¶æ ·æœ¬ï¼Œè¿”å›å•ä¸ªå¼ é‡ |
| **æ‰¹é‡å¤„ç†ä½†éœ€è¦å•ç‹¬è®¿é—®æ¯ä¸ªç»“æœ** | `tore_build_batch` | æ‰¹é‡å¤„ç†ï¼Œè¿”å›å¼ é‡åˆ—è¡¨ï¼Œå¯å•ç‹¬è®¿é—®æ¯ä¸ªç»“æœ |
| **æ‰¹é‡å¤„ç†ä¸”éœ€è¦å †å ç»“æœ** | `tore_build_batch_stacked` | æ‰¹é‡å¤„ç†ï¼Œç›´æ¥è¿”å›å †å å¥½çš„batchå¼ é‡ï¼Œæ•ˆç‡æœ€é«˜ |
| **éœ€è¦resizeåˆ°å›ºå®šå°ºå¯¸** | `tore_build_*_resized` | æŒ‰æ¯”ä¾‹resizeäº‹ä»¶åæ ‡ |
| **éœ€è¦æ­£æ–¹å½¢è¾“å‡ºï¼ˆå¦‚ViTï¼‰** | `tore_build_*_square` | è¾“å‡ºæ­£æ–¹å½¢TOREè¡¨ç¤º |

### ğŸ“Š æ¥å£é€‰æ‹©å†³ç­–æ ‘

```
éœ€è¦resizeå—ï¼Ÿ
â”œâ”€ æ˜¯ â†’ éœ€è¦æ­£æ–¹å½¢è¾“å‡ºå—ï¼Ÿ
â”‚   â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ *_square ç³»åˆ—æ¥å£
â”‚   â””â”€ å¦ â†’ ä½¿ç”¨ *_resized ç³»åˆ—æ¥å£
â””â”€ å¦ â†’ ä½¿ç”¨åŸºç¡€æ¥å£ï¼ˆæ— resizeï¼‰
    â”œâ”€ å•æ ·æœ¬ â†’ tore_build_single
    â”œâ”€ æ‰¹é‡ä½†éœ€å•ç‹¬ç»“æœ â†’ tore_build_batch
    â””â”€ æ‰¹é‡ä¸”éœ€å †å  â†’ tore_build_batch_stacked
```

## APIæ¥å£è¯¦è§£

### 1. åŸºç¡€å•æ ·æœ¬å¤„ç†ï¼ˆv0.0.1ä¿ç•™ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **å®æ—¶æ¨ç†**ï¼šå¤„ç†å•ä¸ªäº‹ä»¶æµæ ·æœ¬
- âœ… **è°ƒè¯•å¼€å‘**ï¼šå¿«é€ŸéªŒè¯ç®—æ³•æ•ˆæœ
- âœ… **å°æ•°æ®é›†å®éªŒ**ï¼šæ•°æ®é‡è¾ƒå°æ—¶é¿å…æ‰¹å¤„ç†å¼€é”€
- âœ… **å†…å­˜å—é™**ï¼šGPUå†…å­˜ä¸è¶³æ—¶é€ä¸ªå¤„ç†

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **å¤§æ‰¹é‡è®­ç»ƒ**ï¼šæ•ˆç‡ä½äºæ‰¹å¤„ç†æ¥å£
- âŒ **éœ€è¦æ¢¯åº¦å›ä¼ **ï¼šå•æ ·æœ¬æ— æ³•åˆ©ç”¨æ‰¹å½’ä¸€åŒ–ç­‰æ“ä½œ

```python
tore_cuda.tore_build_single(
    events: torch.Tensor,      # [N,4] CUDA tensor, æ ¼å¼ (x,y,t,p)
    H: int,                    # è¾“å‡ºé«˜åº¦
    W: int,                    # è¾“å‡ºå®½åº¦
    K: int,                    # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                 # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,               # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query: Optional[int],    # æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æœ€å¤§æ—¶é—´ï¼‰
    out_chw: bool,             # è¾“å‡ºæ ¼å¼ï¼šTrue->(2K,H,W), False->(2,K,H,W)
    dtype: Optional[torch.dtype]  # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼Œé»˜è®¤torch.float32ï¼‰
) -> torch.Tensor
```

**è¿”å›**: TOREè¡¨ç¤ºå¼ é‡ï¼Œå½¢çŠ¶å–å†³äºout_chwå‚æ•°å’Œè¾“å…¥æ•°æ®ç±»å‹

### 2. åŸºç¡€æ‰¹é‡å¤„ç†ï¼ˆv0.0.1ä¿ç•™ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **è®­ç»ƒæµæ°´çº¿**ï¼šéœ€è¦å•ç‹¬è®¿é—®æ¯ä¸ªæ ·æœ¬çš„ç»“æœ
- âœ… **æ•°æ®å¢å¼º**ï¼šå¯¹æ¯ä¸ªæ ·æœ¬è¿›è¡Œä¸åŒåå¤„ç†
- âœ… **å¼‚æ„å¤„ç†**ï¼šä¸åŒæ ·æœ¬éœ€è¦ä¸åŒåç»­æ“ä½œ
- âœ… **è°ƒè¯•åˆ†æ**ï¼šéœ€è¦æ£€æŸ¥å•ä¸ªæ ·æœ¬çš„ä¸­é—´ç»“æœ

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **éœ€è¦å¼ é‡è¿ç®—**ï¼šè¿”å›çš„æ˜¯åˆ—è¡¨ï¼Œéœ€è¦æ‰‹åŠ¨stack
- âŒ **GPUå†…å­˜ç´§å¼ **ï¼šåˆ—è¡¨å½¢å¼æ— æ³•ä¼˜åŒ–å†…å­˜å¸ƒå±€

```python
tore_cuda.tore_build_batch(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    H: int,                           # è¾“å‡ºé«˜åº¦
    W: int,                           # è¾“å‡ºå®½åº¦
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> List[torch.Tensor]
```

**è¿”å›**: TOREè¡¨ç¤ºå¼ é‡åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªè¾“å…¥æ ·æœ¬

### 3. åŸºç¡€æ‰¹é‡å †å å¤„ç†ï¼ˆv0.0.1ä¿ç•™ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **æ·±åº¦å­¦ä¹ è®­ç»ƒ**ï¼šç›´æ¥å¾—åˆ°batchå¼ é‡ï¼Œé€‚é…DataLoader
- âœ… **CNNæ¨ç†**ï¼šæ‰¹é‡è¾“å…¥åˆ°å·ç§¯ç½‘ç»œ
- âœ… **GPUæ•ˆç‡ä¼˜åŒ–**ï¼šè¿ç»­å†…å­˜å¸ƒå±€ï¼Œè®¡ç®—æ•ˆç‡æœ€é«˜
- âœ… **å¼ é‡è¿ç®—**ï¼šå¯ç›´æ¥è¿›è¡Œbatchçº§åˆ«çš„çŸ©é˜µè¿ç®—
- âœ… **ç”Ÿäº§éƒ¨ç½²**ï¼šæ ‡å‡†çš„æ‰¹å¤„ç†æµæ°´çº¿

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **éœ€è¦å•ç‹¬å¤„ç†æ¯ä¸ªæ ·æœ¬**ï¼šè¿”å›çš„æ˜¯å †å å¼ é‡
- âŒ **æ ·æœ¬éœ€è¦ä¸åŒåå¤„ç†**ï¼šæ‰€æœ‰æ ·æœ¬å¿…é¡»ç»Ÿä¸€å¤„ç†

```python
tore_cuda.tore_build_batch_stacked(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    H: int,                           # è¾“å‡ºé«˜åº¦
    W: int,                           # è¾“å‡ºå®½åº¦
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

**è¿”å›**: å †å çš„TOREè¡¨ç¤ºå¼ é‡ï¼Œå½¢çŠ¶(B, 2K, H, W)æˆ–(B, 2, K, H, W)

### 4. å¸¦resizeçš„å•æ ·æœ¬å¤„ç†ï¼ˆv0.0.2æ–°å¢ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **æ¨¡å‹è¾“å…¥æ ‡å‡†åŒ–**ï¼šä¸åŒåˆ†è¾¨ç‡äº‹ä»¶ç›¸æœºç»Ÿä¸€å°ºå¯¸
- âœ… **å†…å­˜ä¼˜åŒ–**ï¼šé™ä½é«˜åˆ†è¾¨ç‡äº‹ä»¶çš„å†…å­˜å ç”¨
- âœ… **é¢„å¤„ç†ç®¡é“**ï¼šå•ä¸ªæ ·æœ¬çš„resizeå’ŒTOREæ„å»ºä¸€ä½“åŒ–
- âœ… **ç®—æ³•å¯¹æ¯”**ï¼šæµ‹è¯•ä¸åŒè¾“å…¥å°ºå¯¸å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **å‘ä¸Šresize**ï¼šåªæ”¯æŒå‘ä¸‹resizeï¼ˆç›®æ ‡å°ºå¯¸ â‰¤ åŸå§‹å°ºå¯¸ï¼‰
- âŒ **éœ€è¦ä¿æŒåŸå§‹åæ ‡**ï¼šresizeä¼šæ”¹å˜äº‹ä»¶åæ ‡

```python
tore_cuda.tore_build_single_resized(
    events: torch.Tensor,      # [N,4] CUDA tensor, æ ¼å¼ (x,y,t,p)
    orig_H: int,               # åŸå§‹è¾“å…¥é«˜åº¦
    orig_W: int,               # åŸå§‹è¾“å…¥å®½åº¦
    target_H: int,             # ç›®æ ‡è¾“å‡ºé«˜åº¦
    target_W: int,             # ç›®æ ‡è¾“å‡ºå®½åº¦
    K: int,                    # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                 # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,               # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query: Optional[int],    # æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,             # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]  # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

**ç‰¹ç‚¹**:
- æ”¯æŒå‘ä¸‹resizeï¼ˆç›®æ ‡å°ºå¯¸ â‰¤ åŸå§‹å°ºå¯¸ï¼‰
- äº‹ä»¶åæ ‡æŒ‰æ¯”ä¾‹ç¼©æ”¾
- è¿‡æ»¤è¶…å‡ºç›®æ ‡èŒƒå›´çš„äº‹ä»¶
- **è‡ªåŠ¨ç±»å‹è½¬æ¢**ï¼šæ”¯æŒint32ã€float32ç­‰å¤šç§è¾“å…¥ç±»å‹ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºfloat32è¿›è¡Œresizeè®¡ç®—

### 5. å¸¦æ­£æ–¹å½¢resizeçš„å•æ ·æœ¬å¤„ç†ï¼ˆv0.0.2æ–°å¢ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **ViTæ¨¡å‹é€‚é…**ï¼šVision Transformeréœ€è¦æ­£æ–¹å½¢è¾“å…¥ï¼ˆ224Ã—224, 518Ã—518ç­‰ï¼‰
- âœ… **ImageNeté¢„è®­ç»ƒæ¨¡å‹**ï¼šå¤§å¤šæ•°é¢„è®­ç»ƒæ¨¡å‹ä½¿ç”¨æ­£æ–¹å½¢è¾“å…¥
- âœ… **å›ºå®špatch sizeæ¨¡å‹**ï¼šå¦‚16Ã—16, 14Ã—14ç­‰patchåˆ’åˆ†
- âœ… **æ­£æ–¹å½¢å·ç§¯æ ¸ä¼˜åŒ–**ï¼šæ­£æ–¹å½¢ç‰¹å¾å›¾æœ‰åˆ©äºGPUå†…å­˜å¯¹é½
- âœ… **å¤šå°ºåº¦è®­ç»ƒ**ï¼šåœ¨æ­£æ–¹å½¢è¾“å…¥ä¸Šåº”ç”¨å¤šå°ºåº¦æ•°æ®å¢å¼º

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **çŸ©å½¢ç‰¹å¾ä¿ç•™**ï¼šä¼šæ”¹å˜åŸå§‹å®½é«˜æ¯”
- âŒ **ç²¾ç¡®å‡ ä½•è®¡ç®—**ï¼šcrop/paddingä¼šæ”¹å˜äº‹ä»¶çš„ç©ºé—´åˆ†å¸ƒ
- âŒ **ä½å®½åº¦äº‹ä»¶æµ**ï¼šä»¥å®½åº¦ä¸ºåŸºå‡†å¯èƒ½å¯¼è‡´é«˜åº¦ä¿¡æ¯ä¸¢å¤±

```python
tore_cuda.tore_build_single_square(
    events: torch.Tensor,      # [N,4] CUDA tensor, æ ¼å¼ (x,y,t,p)
    orig_H: int,               # åŸå§‹è¾“å…¥é«˜åº¦
    orig_W: int,               # åŸå§‹è¾“å…¥å®½åº¦
    target_size: int,          # ç›®æ ‡æ­£æ–¹å½¢è¾¹é•¿ï¼ˆå¦‚518ï¼‰
    K: int,                    # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                 # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,               # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query: Optional[int],    # æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,             # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]  # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

**ç‰¹ç‚¹**:
- ä»¥å®½åº¦ä¸ºåŸºå‡†è¿›è¡Œç­‰æ¯”ä¾‹ç¼©æ”¾
- é«˜åº¦>ç›®æ ‡å°ºå¯¸ï¼šä¸­å¿ƒcrop
- é«˜åº¦<ç›®æ ‡å°ºå¯¸ï¼šä¸Šä¸‹å¡«å……ç©ºç™½åŒºåŸŸ
- è‡ªåŠ¨è¿‡æ»¤æ— æ•ˆåæ ‡

### 6. å¸¦resizeçš„æ‰¹é‡å¤„ç†ï¼ˆv0.0.2æ–°å¢ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **å¤šåˆ†è¾¨ç‡è®­ç»ƒé›†**ï¼šä¸åŒäº‹ä»¶ç›¸æœºç»Ÿä¸€å°ºå¯¸å¤„ç†
- âœ… **æ•°æ®é¢„å¤„ç†ç®¡é“**ï¼šresizeå’ŒTOREæ„å»ºä¸€ä½“åŒ–
- âœ… **å†…å­˜ä¼˜åŒ–è®­ç»ƒ**ï¼šé™ä½é«˜åˆ†è¾¨ç‡äº‹ä»¶çš„æ˜¾å­˜å ç”¨
- âœ… **æ¨¡å‹è¾“å…¥æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€ä¸åŒæ•°æ®æºçš„è¾“å…¥å°ºå¯¸

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **éœ€è¦ä¿æŒæ ·æœ¬å·®å¼‚**ï¼šæ‰€æœ‰æ ·æœ¬resizeåˆ°ç›¸åŒå°ºå¯¸
- âŒ **åœ¨çº¿å­¦ä¹ **ï¼šéœ€è¦åŠ¨æ€è°ƒæ•´å°ºå¯¸çš„æƒ…å†µ


```python
tore_cuda.tore_build_batch_resized(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    orig_H_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹é«˜åº¦
    orig_W_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹å®½åº¦
    target_H: int,                    # ç›®æ ‡è¾“å‡ºé«˜åº¦
    target_W: int,                    # ç›®æ ‡è¾“å‡ºå®½åº¦
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> List[torch.Tensor]
```

### 7. å¸¦æ­£æ–¹å½¢resizeçš„æ‰¹é‡å¤„ç†ï¼ˆv0.0.2æ–°å¢ï¼‰

```python
tore_cuda.tore_build_batch_square(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    orig_H_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹é«˜åº¦
    orig_W_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹å®½åº¦
    target_size: int,                 # ç›®æ ‡æ­£æ–¹å½¢è¾¹é•¿
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> List[torch.Tensor]
```

### 8. å¸¦resizeçš„æ‰¹é‡å †å å¤„ç†ï¼ˆv0.0.2æ–°å¢ï¼‰

```python
tore_cuda.tore_build_batch_stacked_resized(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    orig_H_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹é«˜åº¦
    orig_W_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹å®½åº¦
    target_H: int,                    # ç›®æ ‡è¾“å‡ºé«˜åº¦
    target_W: int,                    # ç›®æ ‡è¾“å‡ºå®½åº¦
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

### 9. å¸¦æ­£æ–¹å½¢resizeçš„æ‰¹é‡å †å å¤„ç†ï¼ˆv0.0.2æ–°å¢ï¼‰

```python
tore_cuda.tore_build_batch_stacked_square(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    orig_H_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹é«˜åº¦
    orig_W_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹å®½åº¦
    target_size: int,                 # ç›®æ ‡æ­£æ–¹å½¢è¾¹é•¿
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨ï¼ˆä¿æŒåŸå§‹å°ºå¯¸ï¼‰
```python
import torch
import tore_cuda

# äº‹ä»¶æ•°æ® [N,4] -> (x,y,t,p)
events = torch.tensor([[100,200,100,1], [200,400,200,-1]], 
                     dtype=torch.float32, device='cuda')

# æ„å»ºTOREè¡¨ç¤º
tore = tore_cuda.tore_build_single(events, 720, 1280, 4, 150.0, 5_000_000.0)
print(tore.shape)  # torch.Size([8, 720, 1280])
```

### ViTå…¼å®¹ä½¿ç”¨ï¼ˆresizeåˆ°518Ã—518ï¼‰
```python
# åŸå§‹å°ºå¯¸ 1280Ã—720ï¼Œç›®æ ‡å°ºå¯¸ 518Ã—518
orig_H, orig_W = 720, 1280
target_size = 518

# æ‰¹é‡å¤„ç†
events_list = [events1, events2, ...]  # å¤šä¸ªäº‹ä»¶æ ·æœ¬
orig_H_list = [720] * len(events_list)
orig_W_list = [1280] * len(events_list)

tore_batch = tore_cuda.tore_build_batch_stacked_square(
    events_list, orig_H_list, orig_W_list, target_size,
    K=4, t0=150.0, tmax=5_000_000.0,
    t_query_list=None, out_chw=True, dtype=torch.bfloat16
)
print(tore_batch.shape)  # torch.Size([B, 8, 518, 518])
```

## ğŸ“‹ å®Œæ•´é€‰æ‹©æŒ‡å—æ€»ç»“

### æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©

| ä»»åŠ¡ç±»å‹ | æ¨èæ¥å£ | ç†ç”± |
|----------|----------|------|
| **ç ”ç©¶å®éªŒ** | `tore_build_single` | å¿«é€ŸéªŒè¯ï¼Œçµæ´»è°ƒè¯• |
| **ç”Ÿäº§æ¨ç†** | `tore_build_batch_stacked` | æœ€é«˜æ•ˆç‡ï¼Œæ ‡å‡†è¾“å‡º |
| **ViTè®­ç»ƒ** | `tore_build_batch_stacked_square` | æ­£æ–¹å½¢è¾“å‡ºï¼Œé€‚é…é¢„è®­ç»ƒæ¨¡å‹ |
| **å¤šåˆ†è¾¨ç‡æ•°æ®** | `tore_build_batch_stacked_resized` | ç»Ÿä¸€å°ºå¯¸ï¼Œå†…å­˜ä¼˜åŒ– |
| **æ•°æ®é¢„å¤„ç†** | `tore_build_*_resized` ç³»åˆ— | ä¸€ä½“åŒ–å¤„ç†ï¼Œå‡å°‘I/O |

### æ ¹æ®æ•°æ®è§„æ¨¡é€‰æ‹©

| æ•°æ®è§„æ¨¡ | æ¨èæ¥å£ | é…ç½®å»ºè®® |
|----------|----------|----------|
| **< 100æ ·æœ¬** | `tore_build_single` | é€ä¸ªå¤„ç†ï¼Œç®€å•ç›´æ¥ |
| **100-1000æ ·æœ¬** | `tore_build_batch_stacked` | ä¸­ç­‰batch sizeï¼Œå¹³è¡¡æ•ˆç‡ |
| **> 1000æ ·æœ¬** | `tore_build_batch_stacked` + åˆ†æ‰¹æ¬¡ | é¿å…å†…å­˜æº¢å‡º |
| **æµæ•°æ®** | `tore_build_single` | å®æ—¶å¤„ç†ï¼Œæ— éœ€ç¼“å­˜ |

### æ ¹æ®ç¡¬ä»¶æ¡ä»¶é€‰æ‹©

| ç¡¬ä»¶æ¡ä»¶ | æ¨èæ¥å£ | ä¼˜åŒ–ç­–ç•¥ |
|----------|----------|----------|
| **é«˜ç«¯GPU** | `tore_build_batch_stacked` | å¤§batch sizeï¼Œå……åˆ†åˆ©ç”¨ç®—åŠ› |
| **ä¸­ç«¯GPU** | `tore_build_batch_stacked` | ä¸­ç­‰batch sizeï¼Œå¦‚32-64 |
| **ä½ç«¯GPU** | `tore_build_single` æˆ– å°batch | é¿å…å†…å­˜æº¢å‡º |
| **CPUæ¨ç†** | `tore_build_single` | äº‹ä»¶æ•°æ®éœ€å…ˆè½¬åˆ°CUDA |

## ğŸ¯ å®é™…åº”ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: ViTäº‹ä»¶åˆ†ç±»æ¨¡å‹è®­ç»ƒ
```python
# äº‹ä»¶ç›¸æœºåŸå§‹åˆ†è¾¨ç‡: 1280Ã—720
# ViTæ¨¡å‹è¦æ±‚è¾“å…¥: 518Ã—518
# è®­ç»ƒæ•°æ®: 10,000ä¸ªäº‹ä»¶æ ·æœ¬

import torch
import tore_cuda

# å‡è®¾å·²æœ‰äº‹ä»¶æ•°æ®åˆ—è¡¨
events_list = load_event_data()  # 10,000ä¸ªäº‹ä»¶æ ·æœ¬
orig_H, orig_W = 720, 1280
target_size = 518  # ViTè¾“å…¥å°ºå¯¸
batch_size = 64    # æ ¹æ®GPUå†…å­˜è°ƒæ•´

# åˆ›å»ºDataLoader
dataset = EventDataset(events_list)
dataloader = DataLoader(dataset, batch_size=batch_size, shuffle=True)

for batch_events in dataloader:
    batch_size = len(batch_events)
    
    # å‡†å¤‡åŸå§‹å°ºå¯¸åˆ—è¡¨
    orig_H_list = [orig_H] * batch_size
    orig_W_list = [orig_W] * batch_size
    
    # ä½¿ç”¨æ­£æ–¹å½¢resizeæ¥å£
    tore_batch = tore_cuda.tore_build_batch_stacked_square(
        batch_events, orig_H_list, orig_W_list, target_size,
        K=8, t0=100.0, tmax=1_000_000.0,
        out_chw=True, dtype=torch.bfloat16
    )
    
    # tore_batch.shape: [64, 16, 518, 518]
    # ç›´æ¥è¾“å…¥åˆ°ViTæ¨¡å‹
    predictions = vit_model(tore_batch)
```

### ç¤ºä¾‹2: å®æ—¶äº‹ä»¶æµæ¨ç†
```python
# å®æ—¶å¤„ç†å•ä¸ªäº‹ä»¶æµ
# åŸå§‹åˆ†è¾¨ç‡: 640Ã—480
# ç›®æ ‡åˆ†è¾¨ç‡: 320Ã—240 (é™ä½è®¡ç®—é‡)

def process_event_stream(events, orig_H=480, orig_W=640):
    """å¤„ç†å•ä¸ªäº‹ä»¶æµæ ·æœ¬"""
    tore = tore_cuda.tore_build_single_resized(
        events, orig_H, orig_W, 240, 320,  # resizeåˆ°320Ã—240
        K=4, t0=50.0, tmax=500_000.0,
        out_chw=True, dtype=torch.float16
    )
    return tore

# å®æ—¶å¾ªç¯
while True:
    events = capture_events()  # æ•è·äº‹ä»¶æ•°æ®
    tore = process_event_stream(events)
    result = model(tore.unsqueeze(0))  # æ·»åŠ batchç»´åº¦
```

### ç¤ºä¾‹3: å¤šåˆ†è¾¨ç‡æ•°æ®é›†å¤„ç†
```python
# å¤„ç†æ¥è‡ªä¸åŒäº‹ä»¶ç›¸æœºçš„æ•°æ®
# ç›¸æœº1: 1280Ã—720, ç›¸æœº2: 640Ã—480, ç›¸æœº3: 320Ã—240
# ç»Ÿä¸€resizeåˆ°: 256Ã—256

events_cam1 = load_camera1_data()  # 1280Ã—720
events_cam2 = load_camera2_data()  # 640Ã—480
events_cam3 = load_camera3_data()  # 320Ã—240

# åˆ†åˆ«å¤„ç†ä¸åŒåˆ†è¾¨ç‡
tore1 = tore_cuda.tore_build_batch_stacked_resized(
    events_cam1, [720]*len(events_cam1), [1280]*len(events_cam1), 256, 256,
    K=6, t0=100.0, tmax=1_000_000.0, out_chw=True
)

tore2 = tore_cuda.tore_build_batch_stacked_resized(
    events_cam2, [480]*len(events_cam2), [640]*len(events_cam2), 256, 256,
    K=6, t0=100.0, tmax=1_000_000.0, out_chw=True
)

tore3 = tore_cuda.tore_build_batch_stacked_resized(
    events_cam3, [240]*len(events_cam3), [320]*len(events_cam3), 256, 256,
    K=6, t0=100.0, tmax=1_000_000.0, out_chw=True
)

# ç°åœ¨æ‰€æœ‰æ•°æ®éƒ½æ˜¯256Ã—256ï¼Œå¯ä»¥ç»Ÿä¸€å¤„ç†
all_tore = torch.cat([tore1, tore2, tore3], dim=0)
```

## âš ï¸ å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1: å†…å­˜æº¢å‡º
```python
# âŒ é”™è¯¯ï¼šbatch_sizeå¤ªå¤§
tore = tore_cuda.tore_build_batch_stacked(events_list, H, W, K, ...)

# âœ… æ­£ç¡®ï¼šåˆ†æ‰¹æ¬¡å¤„ç†
batch_size = 32  # æ ¹æ®GPUå†…å­˜è°ƒæ•´
for i in range(0, len(events_list), batch_size):
    batch = events_list[i:i+batch_size]
    tore_batch = tore_cuda.tore_build_batch_stacked(batch, H, W, K, ...)
```

### é”™è¯¯2: æ•°æ®ç±»å‹ä¸åŒ¹é…
```python
# âŒ é”™è¯¯ï¼šäº‹ä»¶æ•°æ®åœ¨CPUä¸Š
events = torch.tensor([[x,y,t,p]])  # é»˜è®¤åœ¨CPU
tore = tore_cuda.tore_build_single(events, H, W, K, ...)  # ä¼šæŠ¥é”™

# âœ… æ­£ç¡®ï¼šå…ˆè½¬ç§»åˆ°CUDA
events = events.cuda()
tore = tore_cuda.tore_build_single(events, H, W, K, ...)
```

### é”™è¯¯3: å‘ä¸Šresize
```python
# âŒ é”™è¯¯ï¼šè¯•å›¾å‘ä¸Šresize
tore = tore_cuda.tore_build_single_resized(events, 240, 320, 480, 640, ...)

# âœ… æ­£ç¡®ï¼šåªæ”¯æŒå‘ä¸‹resize
tore = tore_cuda.tore_build_single_resized(events, 480, 640, 240, 320, ...)
```

## ç‰ˆæœ¬ä¿¡æ¯

```python
print(tore_cuda.tore_version())  # "0.0.2"
print(tore_cuda.__version__)     # "0.0.2"
```

## æ³¨æ„äº‹é¡¹

1. **äº‹ä»¶æ•°æ®æ ¼å¼**: å¿…é¡»æ˜¯CUDA tensorï¼Œå½¢çŠ¶[N,4]ï¼Œåˆ—é¡ºåºä¸º(x,y,t,p)
2. **åæ ‡èŒƒå›´**: xâˆˆ[0,W), yâˆˆ[0,H), tâ‰¥0, pâˆˆ{-1,+1}
3. **resizeé™åˆ¶**: åªå…è®¸å‘ä¸‹resizeï¼ˆç›®æ ‡å°ºå¯¸ â‰¤ åŸå§‹å°ºå¯¸ï¼‰
4. **å†…å­˜è¦æ±‚**: å¤§æ‰¹é‡å¤„ç†æ—¶éœ€è¦è¶³å¤Ÿçš„GPUå†…å­˜
5. **æ•°æ®ç±»å‹**: æ”¯æŒfloat32ã€bfloat16ã€float16

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ‰¹å¤„ç†**: å°½é‡ä½¿ç”¨æ‰¹é‡æ¥å£è€Œéå¾ªç¯è°ƒç”¨å•æ ·æœ¬
2. **æ•°æ®ç±»å‹**: æ ¹æ®æ¨¡å‹éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ï¼ˆbfloat16/float16å¯èŠ‚çœå†…å­˜ï¼‰
3. **äº‹ä»¶è¿‡æ»¤**: åœ¨è¾“å…¥å‰è¿‡æ»¤æ‰æ˜æ˜¾å¼‚å¸¸çš„äº‹ä»¶æ•°æ®
4. **å†…å­˜ç®¡ç†**: å¤§batch sizeæ—¶è€ƒè™‘åˆ†æ‰¹æ¬¡å¤„ç†

## æ›´æ–°æ—¥å¿—

### v0.0.2 (å½“å‰ç‰ˆæœ¬)
- æ–°å¢äº‹ä»¶resizeåŠŸèƒ½ï¼ˆæŒ‰æ¯”ä¾‹å’Œæ­£æ–¹å½¢ï¼‰
- ä¿æŒå®Œå…¨å‘åå…¼å®¹
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨

### v0.0.1
- åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€TOREåŠŸèƒ½