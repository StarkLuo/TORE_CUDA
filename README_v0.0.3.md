# TORE CUDA v0.0.3

TORE (Time-Ordered REpresentation) CUDAå®ç°ï¼Œæ”¯æŒäº‹ä»¶ç›¸æœºçš„æ—¶ç©ºè¡¨ç¤ºæ„å»ºï¼Œæ–°å¢çµæ´»çš„æ­£æ–¹å½¢resizeç­–ç•¥ã€‚

## ç‰ˆæœ¬ä¿¡æ¯
- å½“å‰ç‰ˆæœ¬: 0.0.3
- **æ–°å¢åŠŸèƒ½**: æ­£æ–¹å½¢resizeçš„cropæ¨¡å¼ï¼ˆä»¥çŸ­è¾¹ä¸ºåŸºå‡†ï¼Œé•¿è¾¹ä¸­å¿ƒè£å‰ªï¼‰
- ä¿ç•™åŠŸèƒ½: v0.0.2çš„æ‰€æœ‰åŠŸèƒ½ï¼ˆæŒ‰æ¯”ä¾‹resizeã€æ­£æ–¹å½¢paddingæ¨¡å¼ï¼‰
- å‘åå…¼å®¹: å®Œå…¨å…¼å®¹v0.0.1å’Œv0.0.2ç‰ˆæœ¬çš„æ‰€æœ‰æ¥å£

## å®‰è£…

```bash
pip install .
```

## æ ¸å¿ƒæ¦‚å¿µ

TOREå°†äº‹ä»¶æµè½¬æ¢ä¸ºæ—¶ç©ºä½“ç§¯è¡¨ç¤ºï¼Œæ¯ä¸ªåƒç´ ä½ç½®ä¿ç•™æœ€è¿‘çš„Kä¸ªäº‹ä»¶æ—¶é—´æˆ³ï¼Œç”¨äºåç»­çš„æ·±åº¦å­¦ä¹ å¤„ç†ã€‚

## v0.0.3 æ–°ç‰¹æ€§ï¼šä¸¤ç§æ­£æ–¹å½¢Resizeç­–ç•¥

### ğŸ†š æ­£æ–¹å½¢Resizeç­–ç•¥å¯¹æ¯”

| ç‰¹æ€§ | `*_square` (v0.0.2) | `*_square_crop` (v0.0.3æ–°å¢) |
|------|---------------------|------------------------------|
| **ç¼©æ”¾åŸºå‡†** | ä»¥å®½åº¦ä¸ºåŸºå‡† | ä»¥çŸ­è¾¹ä¸ºåŸºå‡† |
| **é•¿è¾¹å¤„ç†** | Paddingï¼ˆå¡«å……ç©ºç™½ï¼‰ | Cropï¼ˆä¸­å¿ƒè£å‰ªï¼‰ |
| **å†…å®¹è¦†ç›–** | éƒ¨åˆ†åŒºåŸŸä¸ºç©º | å……æ»¡æ•´ä¸ªåŒºåŸŸ |
| **ä¿¡æ¯æŸå¤±** | æ— æŸå¤±ï¼ˆå¯èƒ½æœ‰ç©ºç™½ï¼‰ | é•¿è¾¹ä¿¡æ¯è¢«è£å‰ª |
| **é€‚ç”¨åœºæ™¯** | éœ€è¦ä¿ç•™å…¨éƒ¨å†…å®¹ | éœ€è¦å……æ»¡ç”»é¢ï¼Œå¯æ¥å—è£å‰ª |

### ğŸ“ Resizeç­–ç•¥å›¾è§£

å‡è®¾åŸå§‹å°ºå¯¸ï¼š1280Ã—720ï¼ˆå®½Ã—é«˜ï¼‰ï¼Œç›®æ ‡å°ºå¯¸ï¼š518Ã—518

**ç­–ç•¥1: `*_square` (ä»¥å®½åº¦ä¸ºåŸºå‡†)**
```
åŸå§‹: 1280Ã—720  â†’  ç¼©æ”¾: 518Ã—291  â†’  padding: 518Ã—518
                                      (ä¸Šä¸‹å„å¡«å……113.5åƒç´ )
ç»“æœï¼šå®Œæ•´ä¿ç•™æ‰€æœ‰å†…å®¹ï¼Œä½†æœ‰ç©ºç™½åŒºåŸŸ
```

**ç­–ç•¥2: `*_square_crop` (ä»¥çŸ­è¾¹ä¸ºåŸºå‡†ï¼Œv0.0.3æ–°å¢)**
```
åŸå§‹: 1280Ã—720  â†’  ç¼©æ”¾: 920Ã—518  â†’  ä¸­å¿ƒcrop: 518Ã—518
                                      (å·¦å³å„è£å‰ª201åƒç´ )
ç»“æœï¼šç”»é¢å……æ»¡ï¼Œä½†å·¦å³è¾¹ç¼˜è¢«è£å‰ª
```

## APIé€‰æ‹©æŒ‡å—

### ğŸ” å¦‚ä½•é€‰æ‹©åˆé€‚çš„APIæ¥å£ï¼Ÿ

æ ¹æ®æ‚¨çš„ä½¿ç”¨åœºæ™¯ï¼Œé€‰æ‹©æœ€é€‚åˆçš„APIæ¥å£ï¼š

| åœºæ™¯ | æ¨èAPI | è¯´æ˜ |
|------|---------|------|
| **å•å¼ å›¾åƒå¤„ç†** | `tore_build_single` | å¤„ç†å•ä¸ªäº‹ä»¶æ ·æœ¬ï¼Œè¿”å›å•ä¸ªå¼ é‡ |
| **æ‰¹é‡å¤„ç†ä½†éœ€è¦å•ç‹¬è®¿é—®æ¯ä¸ªç»“æœ** | `tore_build_batch` | æ‰¹é‡å¤„ç†ï¼Œè¿”å›å¼ é‡åˆ—è¡¨ï¼Œå¯å•ç‹¬è®¿é—®æ¯ä¸ªç»“æœ |
| **æ‰¹é‡å¤„ç†ä¸”éœ€è¦å †å ç»“æœ** | `tore_build_batch_stacked` | æ‰¹é‡å¤„ç†ï¼Œç›´æ¥è¿”å›å †å å¥½çš„batchå¼ é‡ï¼Œæ•ˆç‡æœ€é«˜ |
| **éœ€è¦resizeåˆ°å›ºå®šå°ºå¯¸** | `tore_build_*_resized` | æŒ‰æ¯”ä¾‹resizeäº‹ä»¶åæ ‡ |
| **éœ€è¦æ­£æ–¹å½¢è¾“å‡ºï¼ˆä¿ç•™å…¨éƒ¨å†…å®¹ï¼‰** | `tore_build_*_square` | æ­£æ–¹å½¢TOREè¡¨ç¤ºï¼ˆå¯èƒ½æœ‰paddingï¼‰ |
| **éœ€è¦æ­£æ–¹å½¢è¾“å‡ºï¼ˆå……æ»¡ç”»é¢ï¼‰** | `tore_build_*_square_crop` | æ­£æ–¹å½¢TOREè¡¨ç¤ºï¼ˆé•¿è¾¹è£å‰ªï¼‰â­v0.0.3æ–°å¢ |

### ğŸ“Š æ¥å£é€‰æ‹©å†³ç­–æ ‘

```
éœ€è¦resizeå—ï¼Ÿ
â”œâ”€ æ˜¯ â†’ éœ€è¦æ­£æ–¹å½¢è¾“å‡ºå—ï¼Ÿ
â”‚   â”œâ”€ æ˜¯ â†’ éœ€è¦ä¿ç•™å…¨éƒ¨å†…å®¹è¿˜æ˜¯å……æ»¡ç”»é¢ï¼Ÿ
â”‚   â”‚   â”œâ”€ ä¿ç•™å…¨éƒ¨å†…å®¹ï¼ˆå¯æ¥å—paddingï¼‰ â†’ ä½¿ç”¨ *_square ç³»åˆ—æ¥å£
â”‚   â”‚   â””â”€ å……æ»¡ç”»é¢ï¼ˆå¯æ¥å—è£å‰ªï¼‰ â†’ ä½¿ç”¨ *_square_crop ç³»åˆ—æ¥å£ â­v0.0.3
â”‚   â””â”€ å¦ â†’ ä½¿ç”¨ *_resized ç³»åˆ—æ¥å£
â””â”€ å¦ â†’ ä½¿ç”¨åŸºç¡€æ¥å£ï¼ˆæ— resizeï¼‰
    â”œâ”€ å•æ ·æœ¬ â†’ tore_build_single
    â”œâ”€ æ‰¹é‡ä½†éœ€å•ç‹¬ç»“æœ â†’ tore_build_batch
    â””â”€ æ‰¹é‡ä¸”éœ€å †å  â†’ tore_build_batch_stacked
```

## APIæ¥å£è¯¦è§£

### 1. åŸºç¡€å•æ ·æœ¬å¤„ç†ï¼ˆv0.0.1ä¿ç•™ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **å®æ—¶æ¨ç†**ï¼šå¤„ç†å•ä¸ªäº‹ä»¶æµæ ·æœ¬
- âœ… **è°ƒè¯•å¼€å‘**ï¼šå¿«é€ŸéªŒè¯ç®—æ³•æ•ˆæœ
- âœ… **å°æ•°æ®é›†å®éªŒ**ï¼šæ•°æ®é‡è¾ƒå°æ—¶é¿å…æ‰¹å¤„ç†å¼€é”€
- âœ… **å†…å­˜å—é™**ï¼šGPUå†…å­˜ä¸è¶³æ—¶é€ä¸ªå¤„ç†

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **å¤§æ‰¹é‡è®­ç»ƒ**ï¼šæ•ˆç‡ä½äºæ‰¹å¤„ç†æ¥å£
- âŒ **éœ€è¦æ¢¯åº¦å›ä¼ **ï¼šå•æ ·æœ¬æ— æ³•åˆ©ç”¨æ‰¹å½’ä¸€åŒ–ç­‰æ“ä½œ

```python
tore_cuda.tore_build_single(
    events: torch.Tensor,      # [N,4] CUDA tensor, æ ¼å¼ (x,y,t,p)
    H: int,                    # è¾“å‡ºé«˜åº¦
    W: int,                    # è¾“å‡ºå®½åº¦
    K: int,                    # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                 # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,               # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query: Optional[int],    # æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æœ€å¤§æ—¶é—´ï¼‰
    out_chw: bool,             # è¾“å‡ºæ ¼å¼ï¼šTrue->(2K,H,W), False->(2,K,H,W)
    dtype: Optional[torch.dtype]  # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼Œé»˜è®¤torch.float32ï¼‰
) -> torch.Tensor
```

**è¿”å›**: TOREè¡¨ç¤ºå¼ é‡ï¼Œå½¢çŠ¶å–å†³äºout_chwå‚æ•°å’Œè¾“å…¥æ•°æ®ç±»å‹

### 2. åŸºç¡€æ‰¹é‡å¤„ç†ï¼ˆv0.0.1ä¿ç•™ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **è®­ç»ƒæµæ°´çº¿**ï¼šéœ€è¦å•ç‹¬è®¿é—®æ¯ä¸ªæ ·æœ¬çš„ç»“æœ
- âœ… **æ•°æ®å¢å¼º**ï¼šå¯¹æ¯ä¸ªæ ·æœ¬è¿›è¡Œä¸åŒåå¤„ç†
- âœ… **å¼‚æ„å¤„ç†**ï¼šä¸åŒæ ·æœ¬éœ€è¦ä¸åŒåç»­æ“ä½œ
- âœ… **è°ƒè¯•åˆ†æ**ï¼šéœ€è¦æ£€æŸ¥å•ä¸ªæ ·æœ¬çš„ä¸­é—´ç»“æœ

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **éœ€è¦å¼ é‡è¿ç®—**ï¼šè¿”å›çš„æ˜¯åˆ—è¡¨ï¼Œéœ€è¦æ‰‹åŠ¨stack
- âŒ **GPUå†…å­˜ç´§å¼ **ï¼šåˆ—è¡¨å½¢å¼æ— æ³•ä¼˜åŒ–å†…å­˜å¸ƒå±€

```python
tore_cuda.tore_build_batch(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    H: int,                           # è¾“å‡ºé«˜åº¦
    W: int,                           # è¾“å‡ºå®½åº¦
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> List[torch.Tensor]
```

**è¿”å›**: TOREè¡¨ç¤ºå¼ é‡åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªè¾“å…¥æ ·æœ¬

### 3. åŸºç¡€æ‰¹é‡å †å å¤„ç†ï¼ˆv0.0.1ä¿ç•™ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **æ·±åº¦å­¦ä¹ è®­ç»ƒ**ï¼šç›´æ¥å¾—åˆ°batchå¼ é‡ï¼Œé€‚é…DataLoader
- âœ… **CNNæ¨ç†**ï¼šæ‰¹é‡è¾“å…¥åˆ°å·ç§¯ç½‘ç»œ
- âœ… **GPUæ•ˆç‡ä¼˜åŒ–**ï¼šè¿ç»­å†…å­˜å¸ƒå±€ï¼Œè®¡ç®—æ•ˆç‡æœ€é«˜
- âœ… **å¼ é‡è¿ç®—**ï¼šå¯ç›´æ¥è¿›è¡Œbatchçº§åˆ«çš„çŸ©é˜µè¿ç®—
- âœ… **ç”Ÿäº§éƒ¨ç½²**ï¼šæ ‡å‡†çš„æ‰¹å¤„ç†æµæ°´çº¿

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **éœ€è¦å•ç‹¬å¤„ç†æ¯ä¸ªæ ·æœ¬**ï¼šè¿”å›çš„æ˜¯å †å å¼ é‡
- âŒ **æ ·æœ¬éœ€è¦ä¸åŒåå¤„ç†**ï¼šæ‰€æœ‰æ ·æœ¬å¿…é¡»ç»Ÿä¸€å¤„ç†

```python
tore_cuda.tore_build_batch_stacked(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    H: int,                           # è¾“å‡ºé«˜åº¦
    W: int,                           # è¾“å‡ºå®½åº¦
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

**è¿”å›**: å †å çš„TOREè¡¨ç¤ºå¼ é‡ï¼Œå½¢çŠ¶(B, 2K, H, W)æˆ–(B, 2, K, H, W)

### 4. å¸¦resizeçš„å•æ ·æœ¬å¤„ç†ï¼ˆv0.0.2ä¿ç•™ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **æ¨¡å‹è¾“å…¥æ ‡å‡†åŒ–**ï¼šä¸åŒåˆ†è¾¨ç‡äº‹ä»¶ç›¸æœºç»Ÿä¸€å°ºå¯¸
- âœ… **å†…å­˜ä¼˜åŒ–**ï¼šé™ä½é«˜åˆ†è¾¨ç‡äº‹ä»¶çš„å†…å­˜å ç”¨
- âœ… **é¢„å¤„ç†ç®¡é“**ï¼šå•ä¸ªæ ·æœ¬çš„resizeå’ŒTOREæ„å»ºä¸€ä½“åŒ–
- âœ… **ç®—æ³•å¯¹æ¯”**ï¼šæµ‹è¯•ä¸åŒè¾“å…¥å°ºå¯¸å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **å‘ä¸Šresize**ï¼šåªæ”¯æŒå‘ä¸‹resizeï¼ˆç›®æ ‡å°ºå¯¸ â‰¤ åŸå§‹å°ºå¯¸ï¼‰
- âŒ **éœ€è¦ä¿æŒåŸå§‹åæ ‡**ï¼šresizeä¼šæ”¹å˜äº‹ä»¶åæ ‡

```python
tore_cuda.tore_build_single_resized(
    events: torch.Tensor,      # [N,4] CUDA tensor, æ ¼å¼ (x,y,t,p)
    orig_H: int,               # åŸå§‹è¾“å…¥é«˜åº¦
    orig_W: int,               # åŸå§‹è¾“å…¥å®½åº¦
    target_H: int,             # ç›®æ ‡è¾“å‡ºé«˜åº¦
    target_W: int,             # ç›®æ ‡è¾“å‡ºå®½åº¦
    K: int,                    # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                 # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,               # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query: Optional[int],    # æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,             # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]  # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

**ç‰¹ç‚¹**:
- æ”¯æŒå‘ä¸‹resizeï¼ˆç›®æ ‡å°ºå¯¸ â‰¤ åŸå§‹å°ºå¯¸ï¼‰
- äº‹ä»¶åæ ‡æŒ‰æ¯”ä¾‹ç¼©æ”¾
- è¿‡æ»¤è¶…å‡ºç›®æ ‡èŒƒå›´çš„äº‹ä»¶
- **è‡ªåŠ¨ç±»å‹è½¬æ¢**ï¼šæ”¯æŒint32ã€float32ç­‰å¤šç§è¾“å…¥ç±»å‹ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºfloat32è¿›è¡Œresizeè®¡ç®—

### 5. å¸¦æ­£æ–¹å½¢resizeçš„å•æ ·æœ¬å¤„ç† - Paddingæ¨¡å¼ï¼ˆv0.0.2ä¿ç•™ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **å®Œæ•´å†…å®¹ä¿ç•™**ï¼šéœ€è¦ä¿ç•™äº‹ä»¶æµçš„æ‰€æœ‰ç©ºé—´ä¿¡æ¯
- âœ… **è¯­ä¹‰åˆ†å‰²ä»»åŠ¡**ï¼šéœ€è¦å®Œæ•´çš„åœºæ™¯ä¿¡æ¯
- âœ… **ä½é«˜åº¦äº‹ä»¶æµ**ï¼šåŸå§‹é«˜åº¦è¾ƒå°ï¼Œé¿å…è¿›ä¸€æ­¥è£å‰ª
- âœ… **åç»­éœ€è¦åå‘æ˜ å°„**ï¼špaddingåŒºåŸŸå¯ä»¥è¢«æ ‡è®°å’Œå¤„ç†

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **å¯†é›†é¢„æµ‹ä»»åŠ¡**ï¼špaddingåŒºåŸŸä¼šå½±å“é¢„æµ‹ç»“æœ
- âŒ **éœ€è¦å……æ»¡ç”»é¢**ï¼šä¼šæœ‰ç©ºç™½åŒºåŸŸ

```python
tore_cuda.tore_build_single_square(
    events: torch.Tensor,      # [N,4] CUDA tensor, æ ¼å¼ (x,y,t,p)
    orig_H: int,               # åŸå§‹è¾“å…¥é«˜åº¦
    orig_W: int,               # åŸå§‹è¾“å…¥å®½åº¦
    target_size: int,          # ç›®æ ‡æ­£æ–¹å½¢è¾¹é•¿ï¼ˆå¦‚518ï¼‰
    K: int,                    # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                 # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,               # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query: Optional[int],    # æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,             # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]  # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

**ç‰¹ç‚¹**:
- ä»¥å®½åº¦ä¸ºåŸºå‡†è¿›è¡Œç­‰æ¯”ä¾‹ç¼©æ”¾
- é«˜åº¦>ç›®æ ‡å°ºå¯¸ï¼šä¸­å¿ƒcrop
- é«˜åº¦<ç›®æ ‡å°ºå¯¸ï¼šä¸Šä¸‹å¡«å……ç©ºç™½åŒºåŸŸ
- è‡ªåŠ¨è¿‡æ»¤æ— æ•ˆåæ ‡

### 6. å¸¦æ­£æ–¹å½¢resizeçš„å•æ ·æœ¬å¤„ç† - Cropæ¨¡å¼ï¼ˆv0.0.3æ–°å¢ï¼‰â­

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **ç›®æ ‡æ£€æµ‹**ï¼šå……æ»¡ç”»é¢ï¼Œæé«˜æ£€æµ‹æ•ˆç‡
- âœ… **å›¾åƒåˆ†ç±»**ï¼šæœ€å¤§åŒ–åˆ©ç”¨è¾“å…¥åŒºåŸŸ
- âœ… **æ³¨æ„åŠ›æœºåˆ¶**ï¼šé¿å…paddingåŒºåŸŸå¹²æ‰°attention
- âœ… **é«˜å®½æ¯”æ¥è¿‘1:1çš„åœºæ™¯**ï¼šè£å‰ªæŸå¤±è¾ƒå°
- âœ… **ViTæ¨¡å‹**ï¼šå……åˆ†åˆ©ç”¨patchåŒºåŸŸï¼Œæ— ç©ºç™½

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ **éœ€è¦å®Œæ•´åœºæ™¯ä¿¡æ¯**ï¼šé•¿è¾¹ä¼šè¢«è£å‰ª
- âŒ **æç«¯å®½é«˜æ¯”**ï¼šè£å‰ªæŸå¤±è¿‡å¤§ï¼ˆå¦‚16:9å˜1:1ï¼‰

```python
tore_cuda.tore_build_single_square_crop(
    events: torch.Tensor,      # [N,4] CUDA tensor, æ ¼å¼ (x,y,t,p)
    orig_H: int,               # åŸå§‹è¾“å…¥é«˜åº¦
    orig_W: int,               # åŸå§‹è¾“å…¥å®½åº¦
    target_size: int,          # ç›®æ ‡æ­£æ–¹å½¢è¾¹é•¿ï¼ˆå¦‚518ï¼‰
    K: int,                    # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                 # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,               # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query: Optional[int],    # æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,             # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]  # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

**ç‰¹ç‚¹**:
- ä»¥çŸ­è¾¹ä¸ºåŸºå‡†è¿›è¡Œç­‰æ¯”ä¾‹ç¼©æ”¾
- é•¿è¾¹è‡ªåŠ¨ä¸­å¿ƒè£å‰ªåˆ°ç›®æ ‡å°ºå¯¸
- æ— paddingï¼Œç”»é¢å……æ»¡æ•´ä¸ªè¾“å‡ºåŒºåŸŸ
- è‡ªåŠ¨è¿‡æ»¤è£å‰ªåŒºåŸŸå¤–çš„äº‹ä»¶

### 7-12. æ‰¹é‡å¤„ç†æ¥å£

ç±»ä¼¼çš„ï¼Œv0.0.3æ–°å¢äº†3ä¸ªæ‰¹é‡å¤„ç†æ¥å£ï¼Œå¯¹åº”cropæ¨¡å¼ï¼š

- `tore_build_batch_square_crop` - æ‰¹é‡å¤„ç†ï¼Œè¿”å›åˆ—è¡¨
- `tore_build_batch_stacked_square_crop` - æ‰¹é‡å¤„ç†ï¼Œè¿”å›å †å å¼ é‡ â­æ¨è

ä»¥åŠv0.0.2ä¿ç•™çš„æ¥å£ï¼š
- `tore_build_batch_resized` / `tore_build_batch_stacked_resized`
- `tore_build_batch_square` / `tore_build_batch_stacked_square`

**æ‰¹é‡å †å æ¥å£ç¤ºä¾‹**ï¼ˆcropæ¨¡å¼ï¼Œv0.0.3æ–°å¢ï¼‰ï¼š

```python
tore_cuda.tore_build_batch_stacked_square_crop(
    events_list: List[torch.Tensor],  # äº‹ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ [N_i,4]
    orig_H_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹é«˜åº¦
    orig_W_list: List[int],           # æ¯ä¸ªæ ·æœ¬çš„åŸå§‹å®½åº¦
    target_size: int,                 # ç›®æ ‡æ­£æ–¹å½¢è¾¹é•¿
    K: int,                           # æ¯ä¸ªåƒç´ ä¿ç•™çš„äº‹ä»¶æ•°
    t0: float,                        # æœ€å°æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    tmax: float,                      # æœ€å¤§æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    t_query_list: Optional[List[int]], # æ¯ä¸ªæ ·æœ¬çš„æŸ¥è¯¢æ—¶é—´ç‚¹ï¼ˆå¯é€‰ï¼‰
    out_chw: bool,                    # è¾“å‡ºæ ¼å¼
    dtype: Optional[torch.dtype]      # è¾“å‡ºæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰
) -> torch.Tensor
```

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: å¯¹æ¯”ä¸¤ç§æ­£æ–¹å½¢resizeç­–ç•¥

```python
import torch
import tore_cuda

# åŸå§‹äº‹ä»¶æ•°æ®ï¼š1280Ã—720
events = torch.randn(10000, 4, device='cuda')  # [N,4]
orig_H, orig_W = 720, 1280
target_size = 518

# æ–¹æ³•1ï¼šPaddingæ¨¡å¼ï¼ˆä¿ç•™å…¨éƒ¨å†…å®¹ï¼‰
tore_padding = tore_cuda.tore_build_single_square(
    events, orig_H, orig_W, target_size,
    K=4, t0=150.0, tmax=5_000_000.0,
    out_chw=True
)
print(f"Paddingæ¨¡å¼: {tore_padding.shape}")  # [8, 518, 518]
# ç‰¹ç‚¹ï¼šå®Œæ•´ä¿ç•™æ‰€æœ‰äº‹ä»¶ï¼Œä½†æœ‰ç©ºç™½åŒºåŸŸï¼ˆä¸Šä¸‹å„çº¦113åƒç´ ï¼‰

# æ–¹æ³•2ï¼šCropæ¨¡å¼ï¼ˆå……æ»¡ç”»é¢ï¼Œv0.0.3æ–°å¢ï¼‰â­
tore_crop = tore_cuda.tore_build_single_square_crop(
    events, orig_H, orig_W, target_size,
    K=4, t0=150.0, tmax=5_000_000.0,
    out_chw=True
)
print(f"Cropæ¨¡å¼: {tore_crop.shape}")  # [8, 518, 518]
# ç‰¹ç‚¹ï¼šç”»é¢å……æ»¡ï¼Œæ— ç©ºç™½ï¼Œä½†å·¦å³è¾¹ç¼˜è¢«è£å‰ªï¼ˆå·¦å³å„çº¦201åƒç´ ï¼‰
```

### ç¤ºä¾‹2: ViTç›®æ ‡æ£€æµ‹è®­ç»ƒï¼ˆæ¨ècropæ¨¡å¼ï¼‰

```python
# åŸå§‹å°ºå¯¸ 1280Ã—720ï¼Œç›®æ ‡å°ºå¯¸ 518Ã—518
# ä½¿ç”¨cropæ¨¡å¼ç¡®ä¿ç”»é¢å……æ»¡ï¼Œæé«˜æ£€æµ‹æ•ˆç‡

import torch
import tore_cuda
from torch.utils.data import DataLoader

orig_H, orig_W = 720, 1280
target_size = 518
batch_size = 64

# å‡è®¾å·²æœ‰äº‹ä»¶æ•°æ®åˆ—è¡¨
events_list = load_event_data()
dataset = EventDataset(events_list)
dataloader = DataLoader(dataset, batch_size=batch_size, shuffle=True)

for batch_events in dataloader:
    batch_size = len(batch_events)
    orig_H_list = [orig_H] * batch_size
    orig_W_list = [orig_W] * batch_size
    
    # ä½¿ç”¨cropæ¨¡å¼ï¼ˆå……æ»¡ç”»é¢ï¼Œæ— paddingå¹²æ‰°ï¼‰â­
    tore_batch = tore_cuda.tore_build_batch_stacked_square_crop(
        batch_events, orig_H_list, orig_W_list, target_size,
        K=8, t0=100.0, tmax=1_000_000.0,
        out_chw=True, dtype=torch.bfloat16
    )
    
    # tore_batch.shape: [64, 16, 518, 518]
    # ç”»é¢å……æ»¡ï¼Œæ— ç©ºç™½åŒºåŸŸï¼Œé€‚åˆå¯†é›†é¢„æµ‹ä»»åŠ¡
    predictions = detection_model(tore_batch)
```

### ç¤ºä¾‹3: è¯­ä¹‰åˆ†å‰²è®­ç»ƒï¼ˆæ¨èpaddingæ¨¡å¼ï¼‰

```python
# è¯­ä¹‰åˆ†å‰²éœ€è¦å®Œæ•´çš„åœºæ™¯ä¿¡æ¯ï¼Œä½¿ç”¨paddingæ¨¡å¼

import torch
import tore_cuda

orig_H, orig_W = 720, 1280
target_size = 518

events_list = load_segmentation_data()
orig_H_list = [orig_H] * len(events_list)
orig_W_list = [orig_W] * len(events_list)

# ä½¿ç”¨paddingæ¨¡å¼ï¼ˆä¿ç•™å®Œæ•´åœºæ™¯ï¼‰
tore_batch = tore_cuda.tore_build_batch_stacked_square(
    events_list, orig_H_list, orig_W_list, target_size,
    K=8, t0=100.0, tmax=1_000_000.0,
    out_chw=True, dtype=torch.float32
)

# å¯¹paddingåŒºåŸŸè¿›è¡Œmaskå¤„ç†
# å‡è®¾paddingåœ¨ä¸Šä¸‹ï¼Œæ¯è¾¹çº¦113åƒç´ 
padding_mask = create_padding_mask(tore_batch.shape, top=113, bottom=113)

# æ¨¡å‹é¢„æµ‹æ—¶å¯ä»¥maskæ‰paddingåŒºåŸŸ
segmentation_pred = segmentation_model(tore_batch)
segmentation_pred_masked = segmentation_pred * padding_mask
```

### ç¤ºä¾‹4: å®æ—¶æ¨ç†å¯¹æ¯”

```python
# å®æ—¶å¤„ç†å•ä¸ªäº‹ä»¶æµ
# æ ¹æ®ä»»åŠ¡é€‰æ‹©åˆé€‚çš„resizeæ¨¡å¼

def process_for_detection(events, orig_H=720, orig_W=1280):
    """ç›®æ ‡æ£€æµ‹ï¼šä½¿ç”¨cropæ¨¡å¼"""
    return tore_cuda.tore_build_single_square_crop(
        events, orig_H, orig_W, 518,
        K=4, t0=50.0, tmax=500_000.0,
        out_chw=True, dtype=torch.float16
    )

def process_for_segmentation(events, orig_H=720, orig_W=1280):
    """è¯­ä¹‰åˆ†å‰²ï¼šä½¿ç”¨paddingæ¨¡å¼"""
    return tore_cuda.tore_build_single_square(
        events, orig_H, orig_W, 518,
        K=4, t0=50.0, tmax=500_000.0,
        out_chw=True, dtype=torch.float16
    )

# å®æ—¶å¾ªç¯
while True:
    events = capture_events()
    
    # æ ¹æ®ä»»åŠ¡é€‰æ‹©
    if task == 'detection':
        tore = process_for_detection(events)
    else:  # segmentation
        tore = process_for_segmentation(events)
    
    result = model(tore.unsqueeze(0))
```

## ğŸ“‹ å®Œæ•´é€‰æ‹©æŒ‡å—æ€»ç»“

### æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©Resizeç­–ç•¥

| ä»»åŠ¡ç±»å‹ | æ¨èæ¥å£ | Resizeç­–ç•¥ | ç†ç”± |
|----------|----------|------------|------|
| **ç›®æ ‡æ£€æµ‹** | `tore_build_*_square_crop` â­ | Cropæ¨¡å¼ | å……æ»¡ç”»é¢ï¼Œæé«˜æ£€æµ‹å¯†åº¦ |
| **å›¾åƒåˆ†ç±»** | `tore_build_*_square_crop` â­ | Cropæ¨¡å¼ | æœ€å¤§åŒ–åˆ©ç”¨è¾“å…¥åŒºåŸŸ |
| **è¯­ä¹‰åˆ†å‰²** | `tore_build_*_square` | Paddingæ¨¡å¼ | ä¿ç•™å®Œæ•´åœºæ™¯ä¿¡æ¯ |
| **å…³é”®ç‚¹æ£€æµ‹** | `tore_build_*_square` | Paddingæ¨¡å¼ | é¿å…è¾¹ç¼˜å…³é”®ç‚¹ä¸¢å¤± |
| **ViT backbone** | `tore_build_*_square_crop` â­ | Cropæ¨¡å¼ | é¿å…paddingå¹²æ‰°attention |
| **å¤šåˆ†è¾¨ç‡æ•°æ®** | `tore_build_*_resized` | è‡ªç”±æ¯”ä¾‹ | ç»Ÿä¸€å°ºå¯¸ä½†ä¿æŒå®½é«˜æ¯” |

### æ ¹æ®åŸå§‹å®½é«˜æ¯”é€‰æ‹©

| åŸå§‹å®½é«˜æ¯” | æ¨èç­–ç•¥ | ä¿¡æ¯æŸå¤± |
|-----------|---------|---------|
| **æ¥è¿‘1:1 (å¦‚640Ã—480)** | Cropæ¨¡å¼ â­ | æŸå¤±<25% |
| **16:10 (å¦‚1280Ã—800)** | Cropæˆ–Padding | æŸå¤±çº¦20% |
| **16:9 (å¦‚1280Ã—720)** | Cropæˆ–Padding | æŸå¤±çº¦30% |
| **21:9 (å¦‚2560Ã—1080)** | Paddingæ¨¡å¼ | CropæŸå¤±>50% |

### APIæ•°é‡æ€»è§ˆ

v0.0.3å…±æä¾›**15ä¸ªAPIæ¥å£**ï¼š

**åŸºç¡€æ¥å£ï¼ˆ3ä¸ªï¼Œv0.0.1ï¼‰**ï¼š
- `tore_build_single`
- `tore_build_batch`
- `tore_build_batch_stacked`

**æŒ‰æ¯”ä¾‹resizeæ¥å£ï¼ˆ3ä¸ªï¼Œv0.0.2ï¼‰**ï¼š
- `tore_build_single_resized`
- `tore_build_batch_resized`
- `tore_build_batch_stacked_resized`

**æ­£æ–¹å½¢Paddingæ¨¡å¼æ¥å£ï¼ˆ3ä¸ªï¼Œv0.0.2ï¼‰**ï¼š
- `tore_build_single_square`
- `tore_build_batch_square`
- `tore_build_batch_stacked_square`

**æ­£æ–¹å½¢Cropæ¨¡å¼æ¥å£ï¼ˆ3ä¸ªï¼Œv0.0.3æ–°å¢ï¼‰** â­ï¼š
- `tore_build_single_square_crop`
- `tore_build_batch_square_crop`
- `tore_build_batch_stacked_square_crop`

## âš ï¸ å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1: é€‰æ‹©äº†ä¸åˆé€‚çš„resizeç­–ç•¥

```python
# âŒ é”™è¯¯ï¼šè¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä½¿ç”¨cropæ¨¡å¼ï¼Œè¾¹ç¼˜ä¿¡æ¯ä¸¢å¤±
tore = tore_cuda.tore_build_single_square_crop(events, 720, 1280, 518, ...)

# âœ… æ­£ç¡®ï¼šè¯­ä¹‰åˆ†å‰²ä½¿ç”¨paddingæ¨¡å¼ï¼Œä¿ç•™å®Œæ•´ä¿¡æ¯
tore = tore_cuda.tore_build_single_square(events, 720, 1280, 518, ...)
```

### é”™è¯¯2: æç«¯å®½é«˜æ¯”ä½¿ç”¨cropæ¨¡å¼

```python
# âŒ é”™è¯¯ï¼š21:9è¶…å®½å±ä½¿ç”¨cropï¼ŒæŸå¤±>50%å†…å®¹
tore = tore_cuda.tore_build_single_square_crop(events, 1080, 2560, 518, ...)

# âœ… æ­£ç¡®ï¼šä½¿ç”¨æŒ‰æ¯”ä¾‹resizeæˆ–paddingæ¨¡å¼
tore = tore_cuda.tore_build_single_resized(events, 1080, 2560, 518, 217, ...)
```

### é”™è¯¯3: å†…å­˜æº¢å‡º

```python
# âŒ é”™è¯¯ï¼šbatch_sizeå¤ªå¤§
tore = tore_cuda.tore_build_batch_stacked(events_list, H, W, K, ...)

# âœ… æ­£ç¡®ï¼šåˆ†æ‰¹æ¬¡å¤„ç†
batch_size = 32  # æ ¹æ®GPUå†…å­˜è°ƒæ•´
for i in range(0, len(events_list), batch_size):
    batch = events_list[i:i+batch_size]
    tore_batch = tore_cuda.tore_build_batch_stacked(batch, H, W, K, ...)
```

### é”™è¯¯4: æ•°æ®ç±»å‹ä¸åŒ¹é…

```python
# âŒ é”™è¯¯ï¼šäº‹ä»¶æ•°æ®åœ¨CPUä¸Š
events = torch.tensor([[x,y,t,p]])  # é»˜è®¤åœ¨CPU
tore = tore_cuda.tore_build_single(events, H, W, K, ...)  # ä¼šæŠ¥é”™

# âœ… æ­£ç¡®ï¼šå…ˆè½¬ç§»åˆ°CUDA
events = events.cuda()
tore = tore_cuda.tore_build_single(events, H, W, K, ...)
```

## ç‰ˆæœ¬å‡çº§å»ºè®®

### ä»v0.0.2å‡çº§åˆ°v0.0.3

1. **è¯„ä¼°ç°æœ‰ä½¿ç”¨çš„`*_square`æ¥å£**ï¼š
   - å¦‚æœç”¨äºç›®æ ‡æ£€æµ‹/åˆ†ç±»ï¼Œè€ƒè™‘è¿ç§»åˆ°`*_square_crop`
   - å¦‚æœç”¨äºè¯­ä¹‰åˆ†å‰²/å…³é”®ç‚¹æ£€æµ‹ï¼Œä¿æŒä½¿ç”¨`*_square`

2. **æ–°é¡¹ç›®å»ºè®®**ï¼š
   - ç›®æ ‡æ£€æµ‹ï¼šä¼˜å…ˆä½¿ç”¨`*_square_crop` â­
   - è¯­ä¹‰åˆ†å‰²ï¼šä½¿ç”¨`*_square`
   - ä¸ç¡®å®šæ—¶ï¼šä¸¤ç§éƒ½è¯•è¯•ï¼Œçœ‹æ•ˆæœ

3. **å®Œå…¨å‘åå…¼å®¹**ï¼š
   - æ‰€æœ‰v0.0.1å’Œv0.0.2çš„æ¥å£ä¿æŒä¸å˜
   - å¯ä»¥æ— ç¼å‡çº§ï¼Œé€æ­¥å°è¯•æ–°åŠŸèƒ½

